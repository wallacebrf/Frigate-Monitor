# Frigate-Monitor
Monitors Frigate Memory, Metrics, and Camera Operation. Restarts Frigate if Memory Usage is too High, Logs Metrics to InfluxDB, and sends emails when cameras are not responding. Please note, this script is written around TrueNAS so the commands to send emails and start/stop containers is TrueNAS specific. 

<!-- ABOUT THE PROJECT -->
## 1.) About the project Details
<div id="About_the_project_Details"></div>

The purpose of this script is to:

 <ul>
    <li>
     Export Frigate Metrics into InfluxDB while NOT requiring the use of the "No-Auth" port ensuring higher levels of security
   </li>
   <li>
      Monitor status of every camera to ensure they are on-line or off-line and send email notifications when camera state changes occur
   </li>
   <li>
      Monitor the memory usage as reported by docker and if the memory usage exceeds an adjustable threshold, restart the container at a set time of day
   </li>
 </ul>

## 2.) Metrics Export
<div id="metrics_export"></div>

The first part of this script will export metrics from the <a href="https://docs.frigate.video/configuration/metrics/">/api/metrics</a> endpoint provided by Frigate. I had issues using Prometheus exporters as I could not get them to properly authenticate on the standard web-GUI port. I was only able to get the exporter to work using the "No-Auth" port which i did not want to use due to security concerns. The script imports the <a href="https://docs.frigate.video/configuration/authentication/">JWT Token Secret</a> value from the Frigate ```config``` directory's .jwt_secret file. Per the Frigate documentation ```If no secret is found on startup, Frigate generates one and stores it in a .jwt_secret file in the config directory.```

The tokens generated by the script last 1 hour and a new token is generated when the current token expires. 

The metrics are exported into InfluxDB so tools like Grafana can be used for visualizations. 

## 3.) Camera Status
<div id="camera_status"></div>

Occasionally some of my cameras stop responding and supplying video to Frigate. They also did the same thing when I previously used Synology Surveillance Station. Surveillance Station though had integrated notification support when cameras were not responding. I wished to have this same functionality in Frigate so i could address the camera issue if it was needed. 

The script monitors the ```frigate_camera_fps``` value for each camera. If that value reports 0.0, indicating no frames are being received, an email notification will be sent. That camera will continue to be monitored until such time as it is reporting greater than 0.0 frames. At this point a new email notification will be sent indicating the camera is on-line again. 

## 4.) Memory Monitoring
<div id="memory_monitoring"></div>

There has been discussion about a possible memory leak in Frigate causing the docker container to use more and more memory. I have experienced this issue and added the ability for the script to automatically restart the Frigate container if the memory is above an adjustable set point. I also wanted to make sure Frigate was restarted at a time of day where the risk of losing a minute or two of video would be acceptable so the script is currently configured to only restart Frigate (when memory exceeds the threshold) at 2:00 AM. When the restart occurs, an email notification is sent. 

## 5.) Installation
<div id="installation"></div>

To install the script, create a directory to store the files. Place the ```frigate_checker.sh``` file inside this directory. If desired additional directories can be created, one called ```config``` and one called ```notifications`` that will store other files. Or all files can use the same base directory just created. 

this script requires the ```multireport_sendemail.py``` file written and maintained by <a href="https://github.com/oxyde1989/standalone-tn-send-email/tree/main">oxyde1989</a>. Place this file where desired. 

Open the ```frigate_checker.sh``` file in your preferred text editor and configure the following variables:

```
log_file_location="/mnt/volume1/logging/notifications"
container_restart_tracker="$log_file_location/frigate_restart_tracker.txt"
email_last_sent="$log_file_location/frigate_checker_last_email_sent.txt"
lock_file_location="$log_file_location/frigate_checker.lock"
frigate_auth_file="$log_file_location/frigate_auth.txt"
config_file_location="/mnt/volume1/hosting/web/config/config_files/frigate_checker_config.txt"
camera_name_file_location="/mnt/volume1/hosting/web/config/config_files/frigate_checker_camera_names.txt"
jwt_secret_file_location="/mnt/volume1/apps/figate/config/.jwt_secret"
capture_interval_adjustment=1
debug=0
truenas_multireport_sendemail="/mnt/volume1/logging/multireport_sendemail.py"
```

<ul>
    <li>
      <strong>log_file_location</strong>: Directory where temporary and other required files generated by this script are stored. This can be the same directory where the ```frigate_checker.sh``` is located, or can be any other location of yoour choice. 
    </li>
    <li>
     <strong>container_restart_tracker</strong>: this text file stores the UNIX time stamp when the script restarts Frigate. This allows the script to only restart Frigate if a set minimum amount of time has elapsed. 
   </li>
   <li>
      <strong>email_last_sent</strong>: this text file stores the UNIX time stamp when the script last sent an email. This allows the script to control how often messages are sent to prevent unwanted bulk emails being sent. 
   </li>
   <li>
      <strong>lock_file_location</strong>: This is the name of a temporary directory created by the script which is subsequently automatically deleted when the script exits. this is to ensure only one copy of the script ever executes at once. 
   </li>
  <li>
      <strong>frigate_auth_file</strong>: This is the name of of a text file where the script will store the jwt_secret token generated to authenticate with Frigate for metrics collection
   </li>
  <li>
      <strong>config_file_location</strong>: This is the name of of a text file that the web-interface adjusts for user settings
   </li>
   <li>
      <strong>camera_name_file_location</strong>: This is a file containing a comma separated list of all cameras used by Frigate. The camera names need to match exactly as they are reported by the /api/metrics page. For example the contents of this file would be ```front_door,back_door,garage,backyard``` for example. 
   </li>
  <li>
      <strong>jwt_secret_file_location</strong>: This needs to point to the Frigate config directory's ```.jwt_secret``` file to allow the script to generate required tokens for metrics export. 
   </li>
  <li>
      <strong>capture_interval_adjustment</strong>: This script can execute multiple times per minute (up to 6x times per minuet). This script is designed to be executed every 60 seconds for continuous data scraping. due to the time needed to execute the script each pass, it is possible the script may not complete wihtin 60 seconds. This variable reduces the time delay between each pass. the default value is 1 second. So if the script is set to execute 4x times per minute, the script will divide 60 by 4 equaling 15 second delay between passes, but adjust that down to 14 seconds of delay between passes. A adjustment value of 1 second should work for most users, but this may need to adjusted to 2 or 3 seconds depending on the speed of the host system. 
   </li>
  <li>
      <strong>debug</strong>: If set to a value of 1, the script will display verbose output and status facilitating issues if the script is not operating correctly. 
   </li>
   <li>
      <strong>truenas_multireport_sendemail</strong>: The full location of where the ```multireport_sendemail.py``` file is located to allow email notifications. 
   </li>
 </ul>
